# Vfマップからの繊維間距離計算

## 概要

繊維体積率（Vf）マップから繊維中心間距離（スペーシング）を計算する方法について説明します。

## 正方格子充填モデル

実装では正方格子充填を仮定しています（計算の簡便さと実用性のため）。

```
o   o   o   o
o   o   o   o
o   o   o   o
o   o   o   o
```

## 数式導出

### 繊維体積率の定義

```
Vf = (繊維断面積) / (単位セル面積)
```

### 正方格子の単位セル

- 繊維直径: d
- 繊維中心間距離（スペーシング）: s
- 繊維断面積: π d² / 4
- 単位セル面積（正方格子）: s²

### Vfの式

```
Vf = (π d² / 4) / s²
   = π d² / (4 s²)
```

### スペーシングの導出

sについて解くと：

```
s² = π d² / (4 Vf)

s = d × √(π / (4 Vf))
  = d × √(π / 4) / √Vf
  = d × 0.8862 / √Vf
```

ここで：
```
√(π / 4) = √0.7854... ≈ 0.8862
```

## 最終式

```
s = √(π/4) × d / √Vf ≈ 0.8862 × d / √Vf
```

| パラメータ | 説明 |
|-----------|------|
| s | 繊維中心間距離（スペーシング）[pixel] |
| d | 繊維直径 [pixel] |
| Vf | 局所繊維体積率 (0-1) |

## 計算例

繊維直径 d = 10 pixel の場合：

| Vf | スペーシング s | 100×100領域の繊維数 |
|----|---------------|---------------------|
| 0.785 (最大) | 10.0 pixel | 100 |
| 0.6 | 11.4 pixel | 77 |
| 0.4 | 14.0 pixel | 51 |
| 0.3 | 16.2 pixel | 38 |
| 0.2 | 19.8 pixel | 26 |
| 0.1 | 28.0 pixel | 13 |

## 繊維密度とVfの関係

繊維密度（単位面積あたりの繊維数）n は：

```
n = 1/s² = Vf / (π d² / 4) = 4 Vf / (π d²)
```

したがって、繊維密度はVfに**線形に比例**します：
- Vf = 0.6 の領域は Vf = 0.1 の領域の **6倍** の繊維数
- Vf = 0.6 の領域は Vf = 0.3 の領域の **2倍** の繊維数

## 実装上の制約

コード内では以下の制約を設けています：

```python
min_spacing = fiber_diameter * scale      # 最小間隔（繊維が重ならない）
max_spacing = fiber_diameter * 10         # 最大間隔（Vf ≈ 0.01相当）

spacing_coeff = np.sqrt(np.pi / 4)  # ≈ 0.8862
spacing = np.clip(
    fiber_diameter * spacing_coeff / np.sqrt(vf),
    min_spacing,
    max_spacing
)
```

## 参考文献

- 正方格子充填の最大Vf: π / 4 ≈ 0.7854 (約78.5%)
- 六方最密充填の最大Vf: π / (2√3) ≈ 0.9069 (約90.7%)
